---
title: "Sampling"gt
output: html_notebook
---

### Setup

```{r, include=FALSE}
library(dplyr)

source(here::here("data_cleaning.R"))
source(here::here("functions.R"))
source(here::here("splits.R"))
```

TODO: should this be removed so that we can include more data in our sets? 

```{r}
credit <- credit |>
  na.omit()
```

**testing the stratified split**
```{r}
# then, create sets
splits <- strat_split(credit, "TARGET", train_prop = 0.7, val_prop = 0.1, seed = 123)
train_strat <- splits$train
val_strat <- splits$val
test_strat <- splits$test

# show they are same proportion
round(prop.table(table(credit$TARGET)), 3)
round(prop.table(table(train_strat$TARGET)), 3)
round(prop.table(table(val_strat$TARGET)), 3)
round(prop.table(table(test_strat$TARGET)), 3)

# show that they are same size
nrow(train_strat) / nrow(credit)
nrow(val_strat) / nrow(credit)
nrow(test_strat) / nrow(credit)
```


```{r}
# names to choose from
colnames(credit)
```

```{r}
# define model (used for all)
logit_mod <- logistic_reg() |>
  set_mode("classification") |>
  set_engine("glm")
```

## Logistic Classifier

### "Natural" (No Undersampling)
```{r}
# then, create sets
splits <- random_split(credit, train_prop = 0.7, val_prop = 0.1, seed = 123)
train_random <- splits$train
val_random <- splits$validation
test_random <- splits$test
```

```{r}
lg_rec <- recipe(TARGET ~ ., data = train_random) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors()) 
               
logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ FAMILY_STATUS_MARRIED + HOUSING_TYPE_PARENTS + HOUSING_TYPE_OWN + AMT_INCOME_TOTAL, data = train_random) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

**I feel that results are just not going to be good here, so need the 50/50 split to 
get anything even decent**

### 50/50 Split

#### random split

```{r}
# undersample
credit_fifty <- undersample_split(credit, 0.5)

# then, create sets
splits <- random_split(credit_fifty, train_prop = 0.7, val_prop = 0.1, seed = 123)
train_random_fifty <- splits$train
val_random_fifty <- splits$validation
test_random_fifty <- splits$test
```

```{r}
nrow(train_random_fifty)

# show they are same proportion
round(prop.table(table(credit_fifty$TARGET)), 3)
round(prop.table(table(train_random_fifty$TARGET)), 3)
round(prop.table(table(val_random_fifty$TARGET)), 3)
round(prop.table(table(test_random_fifty$TARGET)), 3)

# show that they are same size
nrow(train_random_fifty) / nrow(credit_fifty)
nrow(val_random_fifty) / nrow(credit_fifty)
nrow(test_random_fifty) / nrow(credit_fifty)

```

```{r}
lg_rec <- recipe(TARGET ~ ., data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ ., data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + AMT_CREDIT + AMT_INCOME_TOTAL + HOUSING_TYPE_OWN, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + EDUCATION_TYPE_SECONDARY, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + CNT_CHILDREN, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```


```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + HOUSING_TYPE_OWN, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + DOCUMENTS_FLAGGED, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ DOCUMENTS_FLAGGED, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ CNT_CHILDREN, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ AMT_CREDIT + AMT_ANNUITY + AMT_INCOME_TOTAL, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ FLAG_OWN_CAR + FLAG_OWN_REALTY, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

#### stratified split

**TODO: get this working**

these are stratified splits created from the undersampled dataset, hoping to get
some better results

```{r}
# then, create sets
strat_splits_fifty <- strat_split(credit_fifty, "TARGET", train_prop = 0.7, val_prop = 0.1, seed = 123)
train_strat_fifty <- strat_splits_fifty$train
val_strat_fifty <- strat_splits_fifty$val
test_strat_fifty <- strat_splits_fifty$test
```


```{r}
nrow(train_strat_fifty)
sum(rowSums(is.na(train_strat_fifty)) > 0)

# show they are same proportion
round(prop.table(table(credit_fifty$TARGET)), 3)
round(prop.table(table(train_strat_fifty$TARGET)), 3)
round(prop.table(table(val_strat_fifty$TARGET)), 3)
round(prop.table(table(test_strat_fifty$TARGET)), 3)

# show that they are same size
nrow(train_strat_fifty) / nrow(credit_fifty)
nrow(val_strat_fifty) / nrow(credit_fifty)
nrow(test_strat_fifty) / nrow(credit_fifty)
```


**why is this giving me NAN ...?**

```{r}
lg_rec <- recipe(TARGET ~ ., data = train_strat_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec

cross_validation(data = train_strat_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```


```{r}
# then, create sets
strat_splits_thirty <- strat_split(credit_fifty, "TARGET", train_prop = 0.7, val_prop = 0.1, seed = 123)
train_strat_thirty <- strat_splits_thirty$train
val_strat_thirty <- strat_splits_thirty$val
test_strat_thirty <- strat_splits_thirty$test
```

```{r}
# then, create sets
strat_splits <- strat_split(credit, "TARGET", train_prop = 0.7, val_prop = 0.1, seed = 123)
train_strat <- strat_splits$train
val_strat <- strat_splits$val
test_strat <- strat_splits$test
```

# something is not good, have to figure out what that is...

**getting NANs, could this haave to do with the data itself?**

```{r}
lg_rec <- recipe(TARGET ~ ., data = train_strat) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_strat, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```



### 30/70 Split

```{r}
# load data
credit <- credit |>
  na.omit()

# undersample
credit_thirty <- undersample_split(credit, pct_positive=0.3)

# then, create sets
splits <- random_split(credit_thirty, train_prop = 0.7, val_prop = 0.1, seed = 123)
train_random_thirty <- splits$train
val_random_thirty <- splits$validation
test_random_thirty <- splits$test
```

```{r}
# now, try different variations of variables and stuff ..
lg_rec <- recipe(TARGET ~ ., data = train_random_thirty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_thirty, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + DOCUMENTS_FLAGGED, data = train_random_thirty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_thirty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING, data = train_random_thirty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_thirty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```

**overall, it seems like 30/70 split is not enough to get accurate results, 
try a medium ground of 40/60**

## 40/60 Split

```{r}
# load data
credit <- credit |>
  na.omit()

# undersample
credit_forty <- undersample_split(credit, pct_positive=0.4)

# then, create sets
splits <- random_split(credit_forty, train_prop = 0.7, val_prop = 0.1, seed = 123)
train_random_forty <- splits$train
val_random_forty <- splits$validation
test_random_forty <- splits$test
```

```{r}
# now, try different variations of variables and stuff ..
lg_rec <- recipe(TARGET ~ ., data = train_random_forty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_forty, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```


```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + DOCUMENTS_FLAGGED, data = train_random_forty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_forty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = 0.5)
```
**seems like the results here aren't great either, so maybe should stick to 50/50 
stuff moving forward?**

## TODO: playing around with the threshold itself ...

```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + DOCUMENTS_FLAGGED, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

prec_vs_recall <- data.frame()

for (i in seq(0, 1, .05)) {
  df <- cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                           num_splits = 5, no_class = 0, bound = i)
  precision <- df[3, 2]
  recall <- df[4, 2]
  
  prec_vs_recall <- rbind(prec_vs_recall, data.frame(boundary=i, precision=precision, recall=recall))
}

prec_vs_recall
```

## LDA Classifier

```{r}
# define model (used for all)
lda_mod <- discrim_linear() |>
  set_mode("classification") |>
  set_engine("MASS")
```

### "Natural" Split

```{r}
lda_rec <- recipe(TARGET ~ ., data = train_random) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lda_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + DOCUMENTS_FLAGGED, data = train_random) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

### 50/50 split

```{r}
lda_rec <- recipe(TARGET ~ ., data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_naomit(all_predictors()) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lda_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + DOCUMENTS_FLAGGED, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)

cross_validation(data = val_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

Show in New Window
 [1] "SK_ID_CURR"               "CONTRACT_TYPE_REVOLVING"  "FLAG_OWN_CAR"            
 [4] "FLAG_OWN_REALTY"          "CNT_CHILDREN"             "AMT_INCOME_TOTAL"        
 [7] "AMT_CREDIT"               "AMT_ANNUITY"              "AMT_GOODS_PRICE"         
[10] "EDUCATION_TYPE_SECONDARY" "EDUCATION_TYPE_HIGHER"    "FAMILY_STATUS_MARRIED"   
[13] "FAMILY_STATUS_OTHER"      "HOUSING_TYPE_OWN"         "HOUSING_TYPE_PARENTS"    
[16] "DAYS_EMPLOYED"            "DOCUMENTS_FLAGGED"        "TARGET" 

```{r}
lda_rec <- recipe(TARGET ~ HOUSING_TYPE_PARENTS + HOUSING_TYPE_OWN, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lda_rec <- recipe(TARGET ~ FLAG_OWN_REALTY + FLAG_OWN_CAR + HOUSING_TYPE_OWN + HOUSING_TYPE_PARENTS, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lda_rec <- recipe(TARGET ~ AMT_CREDIT + AMT_ANNUITY + AMT_GOODS_PRICE + AMT_INCOME_TOTAL, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lda_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lda_rec <- recipe(TARGET ~ FAMILY_STATUS_OTHER + FAMILY_STATUS_MARRIED, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```
```{r}
lda_rec <- recipe(TARGET ~ CNT_CHILDREN + EDUCATION_TYPE_SECONDARY + EDUCATION_TYPE_HIGHER, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
lda_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + DOCUMENTS_FLAGGED, data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_zv(all_predictors())

lda_wkflow <- workflow() |>
  add_model(lda_mod) |>
  add_recipe(lda_rec)

cross_validation(data = train_random_fifty, model = "lda", model_wkflow = lda_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```


# ...
## ... way down at the botton ...
### Some sort of penalty, things like that (other stuff to get the model to work)


```{r}
# define model with penalty, or something
logit_mod_lasso <- logistic_reg(penalty = 1, mixture=1) |>
  set_mode("classification") |>
  set_engine("glmnet")
```

```{r}
colnames(credit)
```

```{r}
lg_rec <- recipe(TARGET ~ ., data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod_lasso) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

ANOTHER THING THAT I CAN TRY IS MAKING THE INCOME COLLAPSE INTO CATEGORIES? 

```{r}
quantile_25 <- as.numeric(quantile(credit$AMT_INCOME_TOTAL)[2])
quantile_50 <- as.numeric(quantile(credit$AMT_INCOME_TOTAL)[3])
quantile_75 <- as.numeric(quantile(credit$AMT_INCOME_TOTAL)[4])
quantile_25
quantile_50
quantile_75

bottom <- 100000
middle <- 150000
top <- 250000
```

**try using income in categories, instead of just the value? that might help
some things**

```{r}
credit <- credit |>
  na.omit()

credit_income_category <- credit %>%
  mutate(
    INCOME_CATEGORY = case_when(
      AMT_INCOME_TOTAL < bottom ~ "FOURTH", 
      AMT_INCOME_TOTAL > bottom & AMT_INCOME_TOTAL <= middle ~ "THIRD", 
      AMT_INCOME_TOTAL > middle & AMT_INCOME_TOTAL <= top ~ "SECOND", 
      AMT_INCOME_TOTAL > top ~ "FIRST"
    )
  ) %>% 
  mutate(
    INCOME_CLASS_FOURTH = ifelse(INCOME_CATEGORY == "FOURTH", 1, 0), 
    INCOME_CLASS_THIRD = ifelse(INCOME_CATEGORY == "THIRD", 1, 0),
    INCOME_CLASS_SECOND = ifelse(INCOME_CATEGORY == "SECOND", 1, 0),
    INCOME_CLASS_FIRST = ifelse(INCOME_CATEGORY == "FIRST", 1, 0)
  ) %>%
  select (
    SK_ID_CURR,
    # CONTRACT_TYPE_CASH, 
    CONTRACT_TYPE_REVOLVING, 
    FLAG_OWN_CAR,
    FLAG_OWN_REALTY,
    CNT_CHILDREN,
    # AMT_INCOME_TOTAL,
    AMT_CREDIT,
    AMT_ANNUITY,
    AMT_GOODS_PRICE,
    EDUCATION_TYPE_SECONDARY, 
    EDUCATION_TYPE_HIGHER, 
    # EDUCATION_TYPE_OTHER, 
    FAMILY_STATUS_MARRIED, 
    # FAMILY_STATUS_SINGLE, 
    FAMILY_STATUS_OTHER, 
    HOUSING_TYPE_OWN, 
    HOUSING_TYPE_PARENTS, 
    # HOUSING_TYPE_OTHER,
    DAYS_EMPLOYED,
    DOCUMENTS_FLAGGED,
    INCOME_CLASS_FOURTH,
    INCOME_CLASS_THIRD, 
    INCOME_CLASS_SECOND,
    TARGET
  )

credit_income_category <- credit_income_category |>
  na.omit()

# then change those into one-hot-encoded variables, or something like that
```

```{r}
# --
# now, try with the category data
# --

# undersample
credit_income_fifty <- undersample_split(credit_income_category, 0.5)

# then, create sets
splits <- random_split(credit_income_fifty, train_prop = 0.7, val_prop = 0.1, seed = 123)
train_random_income_fifty <- splits$train
val_random_income_fifty <- splits$validation
test_random_income_fifty <- splits$test
```

```{r}
train_random_income_fifty[1:5, ]
```

```{r}
lg_rec <- recipe(TARGET ~ DOCUMENTS_FLAGGED + CONTRACT_TYPE_REVOLVING, data = train_random_income_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_income_fifty, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

** maybe try ridge penalty instead? **

```{r}
# define model with penalty, or something
logit_mod_ridge <- logistic_reg(mixture=0) |>
  set_mode("classification") |>
  set_engine("glm")
```


```{r}
lg_rec <- recipe(TARGET ~ CONTRACT_TYPE_REVOLVING + DOCUMENTS_FLAGGED, data = train_random_income_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod_lasso) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_income_fifty, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

## 55/45 split

```{r}
# undersample
credit_five <- undersample_split(credit, 0.55)

# then, create sets
splits <- random_split(credit_five, train_prop = 0.7, val_prop = 0.1, seed = 123)
train_random_five <- splits$train
val_random_five <- splits$validation
test_random_five <- splits$test
```

```{r}
lg_rec <- recipe(TARGET ~ ., data = train_random_five) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_five, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

## USING SOME MIXTURE COMBINATION


```{r}
lg_rec <- recipe(TARGET ~ ., data = train_random_five) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_five, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```

```{r}
# define model with penalty, or something
logit_mod_mix_1 <- logistic_reg(penalty = .2, mixture=1) |>
  set_mode("classification") |>
  set_engine("glmnet")
```

```{r}
colnames(credit)
```

```{r}
lg_rec <- recipe(TARGET ~ ., data = train_random_fifty) |>
  step_mutate(TARGET = factor(TARGET)) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod_mix_1) |>
  add_recipe(lg_rec)

cross_validation(data = train_random_fifty, model = "logistic", model_wkflow = logit_wkflow,
                 num_splits = 5, no_class = 0, bound = 0.5)
```


