---
title: "Join_with_Installments_sample"
author: "Daniel Alvarez"
format: html
editor: visual
---

```{r}
library(here)
library(readr)
library(dplyr)
library(tidymodels)
library(splitstackshape)
```

```{r}
here::here("DATA 403 Project 2", "data_cleaning.R")
```


```{r}
source(here::here("data_cleaning.R"))
source(here::here("functions.R"))
source(here::here("splits.R"))
source(here::here("models.R"))
```
```{r}
installments <- read.csv("/Users/danielalvarezmorales/Documents/FALL 2025/DATA 403/installments_payments.csv")
```



```{r}
installments_clean <- installments %>%
  mutate(
    AMT_PAYMENT = ifelse(AMT_PAYMENT < 0, NA, AMT_PAYMENT),
    payment_ratio = dplyr::if_else(
      is.na(AMT_INSTALMENT) | AMT_INSTALMENT == 0,
      NA_real_,
      AMT_PAYMENT / AMT_INSTALMENT
    ),
    payment_diff_days = DAYS_ENTRY_PAYMENT - DAYS_INSTALMENT,
    missing_payment_flag = is.na(AMT_PAYMENT),
    missing_entry_date_flag = is.na(DAYS_ENTRY_PAYMENT)
  )

```

```{r}
# helper: prevent -inf
safe_max <- function(x) {
  x_non_na <- x[!is.na(x)]
  if (length(x_non_na) == 0) {
    return(NA_real_)
  } else {
    return(max(x_non_na))
  }
}

```


```{r}
installments_summary <- installments_clean %>%
  group_by(SK_ID_CURR) %>%
  summarise(
    num_installments = n(),
    num_missing_payments = sum(missing_payment_flag),
    pct_missing_payments = mean(missing_payment_flag),
    num_missing_dates = sum(missing_entry_date_flag),
    pct_missing_dates = mean(missing_entry_date_flag),

    avg_payment_ratio = mean(payment_ratio, na.rm = TRUE),
    median_payment_ratio = median(payment_ratio, na.rm = TRUE),
    underpayment_rate = mean(payment_ratio < 1, na.rm = TRUE),
    overpayment_rate  = mean(payment_ratio > 1, na.rm = TRUE),

    avg_delay = mean(payment_diff_days, na.rm = TRUE),
    max_delay = safe_max(payment_diff_days),

    total_amt_paid = sum(AMT_PAYMENT, na.rm = TRUE),
    total_amt_due  = sum(AMT_INSTALMENT, na.rm = TRUE)
  )

```

```{r}
joined <- credit %>%
  left_join(installments_summary, by = "SK_ID_CURR") |> 
  relocate(TARGET, .after = last_col())

joined <- joined |>
  dplyr::select(-SK_ID_CURR)

# Make sure no numeric column has Inf / -Inf
joined <- joined |>
  mutate(across(
    where(is.numeric),
    ~ { .[is.infinite(.)] <- NA_real_; . }
  ))

```


```{r}
splits <- strat_split(
  df     = joined,
  target = "TARGET",      
  train_prop = 0.7,
  val_prop   = 0.1,
  seed       = 123
)

train_strat <- splits$train
val_strat   <- splits$val
test_strat  <- splits$test
```

```{r}
logit_mod <- logistic_reg() |>
  set_mode("classification") |>
  set_engine("glm")
```


```{r}
lg_rec <- recipe(TARGET ~ ., data = train_strat) |>
  step_mutate(TARGET = factor(TARGET, levels=c(1, 0))) |>
  step_dummy(all_nominal_predictors())

logit_wkflow <- workflow() |>
  add_model(logit_mod) |>
  add_recipe(lg_rec)

set.seed(18938)
cvs <- vfold_cv(train_strat, v = 5)

logit_wkflow |>
  fit_resamples(
    resamples = cvs,
    metrics = metric_set(accuracy, f_meas, precision, recall, roc_auc)
  ) |>
  collect_metrics()

```







